# λ³Έ μ½”λ“(integrated_pcd_depth_pipeline_newest.py) ν•λμ— μ΄ν•΄ν•κΈ°

## π― μ΄ μ½”λ“κ°€ ν•λ” μΌ (1λ¬Έμ¥)

**LiDAR ν¬μΈνΈ ν΄λΌμ°λ“ β†’ κΉμ΄ λ§µ μƒμ„±** (μΉ΄λ©”λΌ μ‹μ μ—μ„ κ° ν”½μ…€κΉμ§€μ κ±°λ¦¬)

---

## π“¥ μ…λ ¥ / π“¤ μ¶λ ¥

### μ…λ ¥
```
ncdb-cls-sample/synced_data/pcd/
  β”β”€ 0000000931.pcd    β† LiDAR ν¬μΈνΈ (3D μΆν‘)
  β”β”€ 0000000932.pcd
  β””β”€ ...
```

### μ¶λ ¥
```
ncdb-cls-sample/synced_data/
  β”β”€ newest_pcd/              β† μ •μ λ PCD νμΌ
  β”β”€ newest_depth_maps/       β† 16-bit κΉμ΄ λ§µ
  β”β”€ newest_colormap/         β† μ»¬λ¬ μ‹κ°ν™”
  β”β”€ newest_viz_results/      β† λ¶„μ„ κ·Έλν”„
  β”β”€ diff_results/            β† λΉ„κµ μ΄λ―Έμ§€
  β””β”€ 640x384_newest/          β† 640Γ—384 ν•΄μƒλ„ λ²„μ „
```

---

## πƒ μ‹¤ν–‰ λ…λ Ήμ–΄

```bash
python integrated_pcd_depth_pipeline_newest.py --parent_folder ncdb-cls-sample/synced_data
```

**κ·Έ λΏ?** κ·Έλ, κ·ΈλΏμ΄μ•Ό. λ‚λ¨Έμ§€λ” μλ™.

---

## π”§ μ½”λ“μ 6κ°€μ§€ μ£Όμ” λ‹¨κ³„

### Step 1: λ„λ΅ μ„ ν¬μΈνΈ μ¶”μ¶
```
λ¨λ“  ν¬μΈνΈ μ¤‘μ—μ„
  β†“
Zκ°€ νΉμ • λ²”μ„ (-0.95 ~ 0.5)
  β†“
XY κ±°λ¦¬κ°€ 1 ~ 10m
  β†“
X β‰¤ 0 (μΉ΄λ©”λΌ λ’¤μ½)
  β†“
κ°λ„λ³„λ΅ κ°€μ¥ κ°€κΉμ΄ μ  μ„ νƒ
  β†“
β… λ„λ΅ μ„ ν¬μΈνΈ μ¶”μ¶λ¨
```

### Step 2: ν•©μ„± ν¬μΈνΈ μƒμ„± (κ²€μ€ κ³ λ¦¬)
```
λ„λ΅ μ„ ν¬μΈνΈλ¥Ό κΈ°μ¤€μΌλ΅
  β†“
κ·Έ μ£Όλ³€μ— μ›ν• κ³ λ¦¬ κ·Έλ¦¬κΈ°
  β†“
κ³ λ¦¬ μ„μ λ¨λ“  μ λ“¤μ΄ ν•©μ„± ν¬μΈνΈ
  β†“
β… ν•©μ„± ν¬μΈνΈ μƒμ„±λ¨
```

### Step 3: ν¬μΈνΈ λ³‘ν•©
```
μ›λ³Έ ν¬μΈνΈ + ν•©μ„± ν¬μΈνΈ
  β†“
β… ν†µν•© ν¬μΈνΈ ν΄λΌμ°λ“
```

### Step 4: μΉ΄λ©”λΌ ν¬μ
```
κ° 3D ν¬μΈνΈλ¥Ό
  β†“
μΉ΄λ©”λΌμ 2D μ΄λ―Έμ§€ ν‰λ©΄μ— ν¬μ
  β†“
κ° ν”½μ…€μ κΉμ΄κ°’ κΈ°λ΅
  β†“
β… κΉμ΄ λ§µ μƒμ„± (1920Γ—1536)
```

### Step 5: 640Γ—384 ν•΄μƒλ„ μ¬μƒμ„±
```
Step 4λ¥Ό 640Γ—384 ν•΄μƒλ„λ΅ λ°λ³µ
  β†“
β… κΉμ΄ λ§µ μƒμ„± (640Γ—384)
```

### Step 6: μ‹κ°ν™” & μ €μ¥
```
κΉμ΄ λ§µμ„ λ‹¤μ–‘ν• ν¬λ§·μΌλ΅
  β†“
- 16-bit PNG (μ •λ°€)
- μ»¬λ¬ PNG (μ‹κ°ν™”μ©)
- λ¶„μ„ κ·Έλν”„
- PCD νμΌ
  β†“
β… λ¨λ“  μ¶λ ¥ μ €μ¥λ¨
```

---

## π“ 4κ°€μ§€ μ£Όμ” ν΄λμ¤

### 1οΈβƒ£ VADASFisheyeCameraModel
**μ—­ν• **: 3D ν¬μΈνΈ β†’ 2D ν”½μ…€ μΆν‘ λ³€ν™

```python
model = VADASFisheyeCameraModel(intrinsic_parameters)
u, v, valid = model.project_point(Xc, Yc, Zc)
# (u, v) = ν”½μ…€ μΆν‘
```

**λ‚΄λ¶€ κ³µμ‹**:
```
theta = atan2(β(YcΒ² + ZcΒ²), Xc)
rd = polynomial(theta Γ— scale) / div
u = rd Γ— cos(angle) + ux + W/2
v = rd Γ— sin(angle) + uy + H/2
```

### 2οΈβƒ£ CalibrationDB
**μ—­ν• **: μΉ΄λ©”λΌ λ³΄μ • μ •λ³΄ κ΄€λ¦¬

```python
calib_db = CalibrationDB(calibration_dict)
sensor = calib_db.get("a6")  # a6 μΉ΄λ©”λΌ μ •λ³΄
```

### 3οΈβƒ£ LidarCameraProjector
**μ—­ν• **: ν¬μΈνΈ ν΄λΌμ°λ“ λ°°μΉ ν¬μ

```python
projector = LidarCameraProjector(calib_db)
depth_map = projector.project_cloud_to_depth_map(
    "a6",           # μΉ΄λ©”λΌ μ΄λ¦„
    points,         # NΓ—3 ν¬μΈνΈ λ°°μ—΄
    (1920, 1536)    # ν•΄μƒλ„
)
# μ¶λ ¥: (1536, 1920) κΉμ΄ λ§µ
```

### 4οΈβƒ£ SensorInfo
**μ—­ν• **: μΉ΄λ©”λΌ μ •λ³΄ μ»¨ν…μ΄λ„

```python
sensor_info.name           # "a6"
sensor_info.model          # VADASFisheyeCameraModel
sensor_info.intrinsic      # μΉ΄λ©”λΌ νλΌλ―Έν„°
sensor_info.extrinsic      # LiDAR β†’ Camera λ³€ν™
sensor_info.image_size     # (1920, 1536)
```

---

## π® 4κ°€μ§€ μ£Όμ” ν•¨μ

### 1οΈβƒ£ find_nearest_road_point_and_generate_synthetic_pcd()
**μ…λ ¥**: PCD νμΌ κ²½λ΅

**μ²λ¦¬**:
```
PCD λ΅λ“
  β†“ Z ν•„ν„°, XY ν•„ν„°, X ν•„ν„° μ μ©
  β†“ κ°λ„λ³„ μµκ°€κΉμ΄ μ  μ„ νƒ
  β†“
μ¶λ ¥: closest_line_points, original_points
```

### 2οΈβƒ£ build_c_circles_points_from_cloud()
**μ…λ ¥**: μ›λ³Έ ν¬μΈνΈ λ°°μ—΄

**μ²λ¦¬**:
```
λ³΄λΌμƒ‰ μ  μ„ νƒ (yβ‰0, xβ‰¤0, μµλ‹¨κ±°λ¦¬)
  β†“
κ·Έ μ  μ£Όλ³€μ— μ›ν• κ³ λ¦¬ 50κ° μƒμ„±
  β†“
κ° μ›: 512κ° μ μΌλ΅ λ¶„ν• 
  β†“
x β‰¤ 0 μμ—­λ§ ν•„ν„°λ§
  β†“
μ¶λ ¥: synthetic_points
```

### 3οΈβƒ£ LidarCameraProjector.project_cloud_to_depth_map()
**μ…λ ¥**: ν¬μΈνΈ λ°°μ—΄, ν•΄μƒλ„

**μ²λ¦¬**:
```
κ° ν¬μΈνΈλ¥Ό
  β†“ LiDAR β†’ Camera μΆν‘ λ³€ν™
  β†“ VADAS ν¬μ κ³µμ‹ μ μ©
  β†“ 2D ν”½μ…€ μΆν‘ μ–»μ
  β†“ μ¤ν΄λ£¨μ „ κ²€μ‚¬ (κ°€μ¥ κ°€κΉμ΄ μ  μ°μ„ )
  β†“
μ¶λ ¥: depth_map (HΓ—W λ°°μ—΄)
```

### 4οΈβƒ£ run_integrated_pipeline()
**μ…λ ¥**: ν΄λ” κ²½λ΅, νλΌλ―Έν„°λ“¤

**μ²λ¦¬**:
```
λ¨λ“  PCD νμΌμ— λ€ν•΄
  β†“ Step 1~6 λ°λ³µ (μ„ 6 λ‹¨κ³„ μ°Έκ³ )
  β†“ μ§„ν–‰λ¥  ν‘μ‹
  β†“
μ¶λ ¥: λ¨λ“  κ²°κ³Ό νμΌ μ €μ¥
```

---

## π“ νλΌλ―Έν„° μ΅°μ • κ°€μ΄λ“

| νλΌλ―Έν„° | κΈ°λ³Έκ°’ | ν¨κ³Ό | μ΅°μ • λ°©λ²• |
|---------|------|------|---------|
| `ground_z_min` | -0.95 | μ§€λ©΄ ν•ν• | κ°’μ„ ν¬κ² β†’ λ” μΆμ€ Z λ²”μ„ |
| `ground_z_max` | 0.5 | μ§€λ©΄ μƒν• | κ°’μ„ μ‘κ² β†’ λ” μΆμ€ Z λ²”μ„ |
| `min_xy_distance` | 1.0 | μµμ† κ±°λ¦¬ ν•„ν„° | κ°’μ„ ν¬κ² β†’ μΉ΄λ©”λΌμ— λ” κ°€κΉμ΄ μ λ§ |
| `xy_radius_threshold` | 10.0 | μµλ€ κ±°λ¦¬ ν•„ν„° | κ°’μ„ μ‘κ² β†’ μΉ΄λ©”λΌ μ£Όλ³€λ§ μ²λ¦¬ |
| `diff_point_size` | 3 | λΉ„κµ μ΄λ―Έμ§€ μ  ν¬κΈ° | κ°’μ„ ν¬κ² β†’ λ” λ‘κΊΌμ΄ μ  |

---

## π’΅ μ΄ν•΄ν•λ©΄ μΆ‹μ€ κ°λ… 3κ°€μ§€

### 1οΈβƒ£ μΆν‘κ³„ λ³€ν™
```
LiDAR μΆν‘κ³„ (μ „μ—­ XYZ)
          β†“ extrinsic ν–‰λ ¬ μ μ©
μΉ΄λ©”λΌ μΆν‘κ³„ (μΉ΄λ©”λΌ μ¤‘μ‹¬ κΈ°μ¤€)
          β†“ VADAS ν¬μ κ³µμ‹
μ΄λ―Έμ§€ ν‰λ©΄ (2D ν”½μ…€)
```

### 2οΈβƒ£ κΉμ΄κ°’ = Xc
```
μΉ΄λ©”λΌ μΆν‘κ³„μ—μ„ Xμ¶•μ΄ "μ•μ½" κ±°λ¦¬λ¥Ό μλ―Έ
λ”°λΌμ„ κΉμ΄λ§µμ κ° ν”½μ…€κ°’ = μΉ΄λ©”λΌλ΅λ¶€ν„°μ κ±°λ¦¬(m)
```

### 3οΈβƒ£ μ¤ν΄λ£¨μ „ κ²€μ‚¬
```
κ°™μ€ ν”½μ…€μ— μ—¬λ¬ ν¬μΈνΈ ν¬μλλ©΄?
  β†’ κ°€μ¥ κ°€κΉμ΄ ν¬μΈνΈλ§ μ μ§€
     (κ±°λ¦¬κ°€ μ‘μ€ κ°’μΌλ΅ λ®μ–΄μ“°κΈ°)
```

---

## π€ 640Γ—512 μ¶”κ°€ν•κΈ°

ν„μ¬ μ½”λ“λ” **1920Γ—1536κ³Ό 640Γ—384**λ§ μƒμ„±ν•©λ‹λ‹¤.

**640Γ—512λ„ μ¶”κ°€ν•λ ¤λ©΄**:

1. `run_integrated_pipeline()` ν•¨μμ—μ„ μ°ΎκΈ°
2. 640Γ—384 λ΅μ§μ„ μ°Έκ³ ν•΄μ„ λ³µμ‚¬
3. ν•΄μƒλ„λ§ (640, 512)λ΅ λ³€κ²½
4. μ¶λ ¥ ν΄λ”λ¥Ό `640x512_newest/`λ΅ λ³€κ²½

(ν„μ¬ `test_640x384_div_comparison.py`μ—μ„ μ΄λ―Έ 640Γ—512λ¥Ό ν…μ¤νΈ μ¤‘μ…λ‹λ‹¤)

---

## π“ 5λ¶„ μ•μ— μ‹¤ν–‰ν•κΈ°

```bash
# 1. ν„°λ―Έλ„ μ—΄κΈ°
cd c:\Users\seok436\Documents\VSCode\Projects\point-cloud-creation\point-cloud-creation

# 2. ν™κ²½ ν™μ„±ν™” (μ΄λ―Έ λμ–΄μμΌλ©΄ μ¤ν‚µ)
conda activate point_cloud_env

# 3. μ‹¤ν–‰
python integrated_pcd_depth_pipeline_newest.py --parent_folder ncdb-cls-sample/synced_data

# 4. κ²°κ³Ό ν™•μΈ
# νμΌ νƒμƒ‰κΈ°μ—μ„ ncdb-cls-sample/synced_data/newest_colormap/ μ—΄κΈ°
# μ»¬λ¬λ§µ μ΄λ―Έμ§€λ“¤μ„ λ―Έλ¦¬λ³΄κΈ°λ΅ ν™•μΈ
```

---

## β… μ²΄ν¬λ¦¬μ¤νΈ

μ‹¤ν–‰ μ „ ν™•μΈ:

- [ ] λ°μ΄ν„° ν΄λ” μ΅΄μ¬? `ncdb-cls-sample/synced_data/pcd/`
- [ ] PCD νμΌ μμ? `*.pcd` νμΌ μµμ† 1κ°
- [ ] Python ν™κ²½ ν™μ„±ν™”? (conda)
- [ ] ν•„μ”ν• λΌμ΄λΈλ¬λ¦¬ μ„¤μΉ? (numpy, opencv, open3d λ“±)

μ‹¤ν–‰ ν›„ ν™•μΈ:

- [ ] μ§„ν–‰λ¥  ν‘μ‹ λ‚μ΄?
- [ ] μ¤λ¥ μ—†μ΄ μ™„λ£?
- [ ] μ¶λ ¥ ν΄λ”μ— νμΌλ“¤μ΄ μƒκ²Όλ‚?
- [ ] κΉμ΄ λ§µμ΄ κ²€μ€μƒ‰μΈκ°€, μ»¬λ¬μΈκ°€?

---

## π“ ν•™μµ μμ„

1. **λ¨Όμ € μ΄ν•΄**: μ΄ λ¬Έμ„ (1λ¬Έμ¥ μ”μ•½)
2. **λ‹¤μ μ΄ν•΄**: PIPELINE_QUICK_REFERENCE.md (ν”λ΅μ° λ‹¤μ΄μ–΄κ·Έλ¨)
3. **κΉμ΄ μ΄ν•΄**: PIPELINE_EXPLANATION.md (μ „μ²΄ μƒμ„Έ)
4. **μ½”λ“ μ½κΈ°**: integrated_pcd_depth_pipeline_newest.py μ§μ ‘ μ½κΈ°

---

## π¤” μμ£Ό ν•λ” μ§λ¬Έ

**Q: μ™ ν•©μ„± ν¬μΈνΈλ¥Ό λ§λ“λ‚?**
> A: μ‹¤μ  λ„λ΅ μ •λ³΄λ¥Ό μ¶”κ°€λ΅ λ³΄κ°•ν•κΈ° μ„ν•΄. λ„λ΅ μ„ ν¬μΈνΈλ§μΌλ΅λ” λ¶€μ΅±ν•λ―€λ΅, κ·Έ μ£Όλ³€μ— κ·μΉ™μ μΈ ν¨ν„΄(κ³ λ¦¬)μ„ μ¶”κ°€ν•΄μ„ λ” λ§μ€ κΉμ΄ μ •λ³΄λ¥Ό μ κ³µν•©λ‹λ‹¤.

**Q: 640Γ—384λ” μ™ λ”°λ΅ μƒμ„±?**
> A: λ¨λ°”μΌ/μ„λ² λ””λ“ ν™κ²½μ—μ„ λ” κ°€λ²Όμ΄ λ²„μ „μ΄ ν•„μ”ν•  μ μκΈ° λ•λ¬Έμ…λ‹λ‹¤.

**Q: κΉμ΄ λ§µμ΄ κ²€μ€μƒ‰μΈλ°?**
> A: ν¬μΈνΈκ°€ μΉ΄λ©”λΌ λ’¤μ½(Xc < 0)μ— λ§λ‹¤λ” λ». `--ground_z_min`, `--ground_z_max`λ¥Ό μ΅°μ •ν•΄λ³΄μ„Έμ”.

**Q: λ‡ κ° νμΌ ν…μ¤νΈν•λ ¤λ©΄?**
> A: `pcd/` ν΄λ”μ— 1-2κ°λ§ λ‚¨κΈ°κ³  λ‚λ¨Έμ§€λ” λ‹¤λ¥Έ κ³³μΌλ΅ μ®κΈ΄ ν›„ μ‹¤ν–‰ν•μ„Έμ”.

---

**μ •λ¦¬**: 
```
μ΄ μ½”λ“ = LiDAR ν¬μΈνΈ β†’ μΉ΄λ©”λΌ κΉμ΄ λ§µ λ³€ν™ λ„κµ¬
λ…λ Ήμ–΄ ν• μ¤„ = λ¨λ“  PCD νμΌ μλ™ μ²λ¦¬
μ¶λ ¥ = μ—¬λ¬ ν¬λ§·μ κΉμ΄ μ‹κ°ν™”
```

λ” μ•κ³  μ‹¶μΌλ©΄ λ‹¤λ¥Έ μ„¤λ… λ¬Έμ„λ“¤μ„ μ½μΌμ„Έμ”!
