#!/usr/bin/env python3\n\"\"\"\nê¹Šì´ë§µ ìŠ¤ì¼€ì¼ë§ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸\n\nê°™ì€ PCD íŒŒì¼ë¡œ ìƒì„±ëœ ì›ë³¸(1920Ã—1536)ê³¼ ì¶•ì†Œ(640Ã—512) ê¹Šì´ë§µì„ ë¹„êµí•˜ì—¬\nìŠ¤ì¼€ì¼ë§ì´ ì˜¬ë°”ë¥´ê²Œ ì ìš©ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.\n\"\"\"\n\nimport sys\nimport cv2\nimport numpy as np\nfrom pathlib import Path\nimport json\n\ndef load_depth_map(depth_path):\n    \"\"\"ê¹Šì´ë§µ PNG ë¡œë“œ (CV_32F í¬ë§·)\"\"\"\n    if not depth_path.exists():\n        print(f\"[ERROR] Depth map not found: {depth_path}\")\n        return None\n    \n    depth_uint16 = cv2.imread(str(depth_path), cv2.IMREAD_UNCHANGED)\n    if depth_uint16 is None:\n        print(f\"[ERROR] Failed to load: {depth_path}\")\n        return None\n    \n    # uint16 â†’ float32 ë³€í™˜ (mm â†’ m)\n    depth_float = depth_uint16.astype(np.float32) / 1000.0\n    return depth_float\n\ndef sample_corresponding_pixels(depth_orig, depth_resized, scale_x=1/3, scale_y=1/3):\n    \"\"\"ì›ë³¸ê³¼ ì¶•ì†Œ ê¹Šì´ë§µì—ì„œ ëŒ€ì‘ë˜ëŠ” í”½ì…€ê°’ ìƒ˜í”Œë§\n    \n    ì›ë³¸ (1920Ã—1536)ì˜ í”½ì…€ê³¼ ì¶•ì†Œ (640Ã—512)ì˜ ëŒ€ì‘ í”½ì…€ì„ ì°¾ì•„\n    ê¹Šì´ê°’ì„ ë¹„êµí•©ë‹ˆë‹¤.\n    \n    ì˜ˆ: ì›ë³¸ì˜ (960, 768) â†’ ì¶•ì†Œì˜ (320, 256)\n    \"\"\"\n    if depth_orig is None or depth_resized is None:\n        return None\n    \n    h_orig, w_orig = depth_orig.shape\n    h_resized, w_resized = depth_resized.shape\n    \n    print(f\"\\nğŸ“ í•´ìƒë„ í™•ì¸:\")\n    print(f\"  ì›ë³¸: {w_orig}Ã—{h_orig}\")\n    print(f\"  ì¶•ì†Œ: {w_resized}Ã—{h_resized}\")\n    print(f\"  ìŠ¤ì¼€ì¼: scale_x={scale_x:.3f}, scale_y={scale_y:.3f}\")\n    \n    # ìƒ˜í”Œë§ í¬ì¸íŠ¸ (ì›ë³¸ í•´ìƒë„ì—ì„œ)\n    sample_points_orig = [\n        (960, 768),    # ì¤‘ì‹¬\n        (480, 384),    # ì¢Œìƒ\n        (1440, 1152),  # ìš°í•˜\n        (960, 384),    # ìƒë‹¨ ì¤‘ì•™\n        (960, 1152),   # í•˜ë‹¨ ì¤‘ì•™\n    ]\n    \n    results = []\n    print(f\"\\nğŸ“ ìƒ˜í”Œ í¬ì¸íŠ¸ ë¹„êµ:\")\n    print(f\"{'-'*80}\")\n    print(f\"{'ì›ë³¸ ìœ„ì¹˜':<15} {'ì›ë³¸ ê¹Šì´':<15} {'ì¶•ì†Œ ìœ„ì¹˜':<15} {'ì¶•ì†Œ ê¹Šì´':<15} {'ì°¨ì´':<10}\")\n    print(f\"{'-'*80}\")\n    \n    for x_orig, y_orig in sample_points_orig:\n        # ì›ë³¸ì—ì„œ ê¹Šì´ ì½ê¸°\n        if 0 <= x_orig < w_orig and 0 <= y_orig < h_orig:\n            depth_val_orig = depth_orig[y_orig, x_orig]\n        else:\n            continue\n        \n        # ì¶•ì†Œ ì´ë¯¸ì§€ì˜ ëŒ€ì‘ ì¢Œí‘œ\n        x_resized = int(x_orig * scale_x)\n        y_resized = int(y_orig * scale_y)\n        \n        # ê²½ê³„ ì²´í¬\n        if 0 <= x_resized < w_resized and 0 <= y_resized < h_resized:\n            depth_val_resized = depth_resized[y_resized, x_resized]\n        else:\n            depth_val_resized = -1\n        \n        # ì°¨ì´ ê³„ì‚°\n        if depth_val_orig > 0 and depth_val_resized > 0:\n            diff = abs(depth_val_orig - depth_val_resized)\n            pct_diff = (diff / depth_val_orig) * 100 if depth_val_orig > 0 else 0\n        else:\n            diff = -1\n            pct_diff = -1\n        \n        results.append({\n            'orig_pos': (x_orig, y_orig),\n            'resized_pos': (x_resized, y_resized),\n            'orig_depth': depth_val_orig,\n            'resized_depth': depth_val_resized,\n            'diff': diff,\n            'pct_diff': pct_diff\n        })\n        \n        print(f\"({x_orig:>4}, {y_orig:>4})    \"\n              f\"{depth_val_orig:>8.3f}m     \"\n              f\"({x_resized:>4}, {y_resized:>4})    \"\n              f\"{depth_val_resized:>8.3f}m     \"\n              f\"{diff:>7.3f}m\")\n    \n    print(f\"{'-'*80}\")\n    \n    # í†µê³„\n    valid_results = [r for r in results if r['diff'] >= 0]\n    if valid_results:\n        avg_diff = np.mean([r['diff'] for r in valid_results])\n        max_diff = np.max([r['diff'] for r in valid_results])\n        avg_pct_diff = np.mean([r['pct_diff'] for r in valid_results])\n        \n        print(f\"\\nğŸ“Š í†µê³„:\")\n        print(f\"  í‰ê·  ì°¨ì´: {avg_diff:.4f}m ({avg_pct_diff:.2f}%)\")\n        print(f\"  ìµœëŒ€ ì°¨ì´: {max_diff:.4f}m\")\n        \n        if avg_pct_diff < 1.0:\n            print(f\"  âœ… ìŠ¤ì¼€ì¼ë§ ì •í™•í•¨ (ì°¨ì´ < 1%)\")\n        elif avg_pct_diff < 5.0:\n            print(f\"  âš ï¸ ìŠ¤ì¼€ì¼ë§ ì•½ê°„ ë¶€ì •í™• (1% â‰¤ ì°¨ì´ < 5%)\")\n        else:\n            print(f\"  âŒ ìŠ¤ì¼€ì¼ë§ ë¶€ì •í™• (ì°¨ì´ â‰¥ 5%)\")\n    \n    return results\n\ndef analyze_depth_distribution(depth_map, name=\"\"):\n    \"\"\"ê¹Šì´ë§µ ê°’ ë¶„í¬ ë¶„ì„\"\"\"\n    valid_depths = depth_map[depth_map > 0]\n    \n    if valid_depths.size == 0:\n        print(f\"  [WARN] {name}: No valid depth values\")\n        return\n    \n    print(f\"\\nğŸ“ˆ {name} ê¹Šì´ ë¶„í¬:\")\n    print(f\"  ìµœì†Œ: {valid_depths.min():.3f}m\")\n    print(f\"  ìµœëŒ€: {valid_depths.max():.3f}m\")\n    print(f\"  í‰ê· : {valid_depths.mean():.3f}m\")\n    print(f\"  ì¤‘ì•™: {np.median(valid_depths):.3f}m\")\n    print(f\"  í‘œì¤€í¸ì°¨: {valid_depths.std():.3f}m\")\n    print(f\"  ìœ íš¨ í”½ì…€: {valid_depths.size} / {depth_map.size}\")\n\ndef main():\n    \"\"\"ë©”ì¸ ê²€ì¦ í”„ë¡œì„¸ìŠ¤\"\"\"\n    print(\"\\n\" + \"=\"*80)\n    print(\"ğŸ” ê¹Šì´ë§µ ìŠ¤ì¼€ì¼ë§ ê²€ì¦\")\n    print(\"=\"*80)\n    \n    base_dir = Path(\"/media/seok436/data/ncdb-cls/ncdb-cls/2025-07-11_15-00-27_410410_A/synced_data\")\n    \n    # ì›ë³¸ í•´ìƒë„ í´ë” (ìƒì„±ë˜ì–´ì•¼ í•¨)\n    depth_orig_dir = base_dir.parent / \"depth_maps_newest\"\n    \n    # ì¶•ì†Œ í•´ìƒë„ í´ë” (ìƒˆë¡œ ìƒì„±ëœ ê²ƒ)\n    depth_640x512_dir = base_dir.parent / \"640x512_newest\" / \"depth_maps\"\n    depth_640x384_dir = base_dir.parent / \"640x384_newest\" / \"depth_maps\"\n    \n    print(f\"\\nğŸ“‚ ë””ë ‰í† ë¦¬ í™•ì¸:\")\n    print(f\"  ì›ë³¸ í•´ìƒë„: {depth_orig_dir}\")\n    print(f\"    ì¡´ì¬: {'âœ…' if depth_orig_dir.exists() else 'âŒ'}\")\n    print(f\"  640Ã—512: {depth_640x512_dir}\")\n    print(f\"    ì¡´ì¬: {'âœ…' if depth_640x512_dir.exists() else 'âŒ'}\")\n    print(f\"  640Ã—384: {depth_640x384_dir}\")\n    print(f\"    ì¡´ì¬: {'âœ…' if depth_640x384_dir.exists() else 'âŒ'}\")\n    \n    # í…ŒìŠ¤íŠ¸ íŒŒì¼ ì„ íƒ\n    test_stem = \"0000000001\"\n    \n    depth_orig_path = depth_orig_dir / f\"{test_stem}.png\"\n    depth_640x512_path = depth_640x512_dir / f\"{test_stem}.png\"\n    depth_640x384_path = depth_640x384_dir / f\"{test_stem}.png\"\n    \n    print(f\"\\nğŸ“„ í…ŒìŠ¤íŠ¸ íŒŒì¼: {test_stem}.png\")\n    \n    # ì›ë³¸ í•´ìƒë„ ê¹Šì´ë§µ ë¡œë“œ\n    print(f\"\\n[1] ì›ë³¸ í•´ìƒë„ (1920Ã—1536) ê¹Šì´ë§µ ë¡œë“œ...\")\n    depth_orig = load_depth_map(depth_orig_path)\n    if depth_orig is not None:\n        analyze_depth_distribution(depth_orig, \"ì›ë³¸ (1920Ã—1536)\")\n    else:\n        print(f\"âŒ ì›ë³¸ ê¹Šì´ë§µ ë¡œë“œ ì‹¤íŒ¨\")\n        return\n    \n    # 640Ã—512 ê¹Šì´ë§µ ë¡œë“œ ë° ê²€ì¦\n    print(f\"\\n[2] ì¶•ì†Œ í•´ìƒë„ (640Ã—512) ê¹Šì´ë§µ ë¡œë“œ...\")\n    depth_640x512 = load_depth_map(depth_640x512_path)\n    if depth_640x512 is not None:\n        analyze_depth_distribution(depth_640x512, \"ì¶•ì†Œ (640Ã—512)\")\n        print(f\"\\n[3] ì›ë³¸ vs 640Ã—512 ë¹„êµ:\")\n        sample_corresponding_pixels(depth_orig, depth_640x512, scale_x=1/3, scale_y=1/3)\n    else:\n        print(f\"âŒ 640Ã—512 ê¹Šì´ë§µ ë¡œë“œ ì‹¤íŒ¨\")\n    \n    # 640Ã—384 ê¹Šì´ë§µ ë¡œë“œ ë° ê²€ì¦\n    print(f\"\\n[4] ì¶•ì†Œ í•´ìƒë„ (640Ã—384) ê¹Šì´ë§µ ë¡œë“œ...\")\n    depth_640x384 = load_depth_map(depth_640x384_path)\n    if depth_640x384 is not None:\n        analyze_depth_distribution(depth_640x384, \"ì¶•ì†Œ (640Ã—384)\")\n        print(f\"\\n[5] ì›ë³¸ vs 640Ã—384 ë¹„êµ:\")\n        sample_corresponding_pixels(depth_orig, depth_640x384, scale_x=1/3, scale_y=384/1536)\n    else:\n        print(f\"âŒ 640Ã—384 ê¹Šì´ë§µ ë¡œë“œ ì‹¤íŒ¨\")\n    \n    print(f\"\\n\" + \"=\"*80)\n    print(f\"âœ… ê²€ì¦ ì™„ë£Œ\")\n    print(f\"=\"*80 + \"\\n\")\n\nif __name__ == \"__main__\":\n    main()\n"}}]
