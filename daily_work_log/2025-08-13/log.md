# 2025년 8월 13일 작업 로그

## `compare_depth_scales.py` 스크립트 기능 고도화

### 목표
Depth Anything V2 모델이 생성한 상대 깊이 맵을 Ground Truth(GT) 깊이 맵(기존 `depth_maps`)과 비교하고, GT의 스케일 및 분포에 맞게 보정하는 파이프라인을 구축 및 검증.

### 주요 수정 및 구현 내역

#### 1. 선형 스케일링 (Linear Scaling) 구현
- **목표:** 두 깊이 맵의 평균적인 크기를 맞춘다.
- **방법:**
    - 사용자가 지정한 거리 임계값(예: 8m) 미만의 유효 데이터 영역을 추출.
    - 이 영역에서 GT와 Depth Anything(DA) 값의 평균을 각각 계산.
    - `스케일 팩터 = GT 평균 / DA 평균` 공식을 통해 스케일 팩터를 도출.
    - 계산된 팩터를 전체 DA 맵에 곱하여 `scaled_depth_anything_output`을 생성.
- **시각화:**
    - **Figure 2:** 스케일링된 결과와 GT를 비교하는 상세 진단 차트 (차이 맵, 상대 오차 맵, Q-Q 플롯 등)를 추가.
    - **Figure 3:** 스케일링 후 두 맵의 값 분포를 다양한 거리 구간에서 비교하는 히스토그램을 추가.

#### 2. 히스토그램 매칭 (분포 보정) 구현
- **목표:** 값의 분포(분산, 밀도 등)까지 GT와 유사하게 보정하여 값 쏠림 현상을 해결.
- **방법:**
    - 선형 스케일링과 동일하게, 사용자가 지정한 임계값 미만 영역의 데이터를 '학습 데이터'로 사용.
    - `np.interp` 함수를 사용하여, 학습 데이터의 누적 분포 함수(CDF)를 기반으로 DA 값들을 GT 값의 분포에 일대일로 매핑.
    - 이 매핑 규칙을 전체 DA 맵에 적용하여 `matched_depth_output`을 생성.
- **시각화:**
    - **Figure 4:** 분포 매칭의 효과를 확인.
        - (상단) GT 맵과 매칭된 DA 맵의 시각적 비교.
        - (하단) 전체 유효값 및 학습에 사용된 임계값 미만 영역에서의 히스토그램을 겹쳐 그려 분포 일치도를 확인. (가독성을 위해 GT는 반투명 면, DA는 선으로 스타일 구분)

#### 3. 일반화 성능 검증 로직 추가
- **목표:** 학습에 사용되지 않은 데이터(임계값 이상 거리)에서도 분포 매칭 규칙이 유효하게 작동하는지 검증.
- **방법:**
    - GT 값이 사용자가 지정한 임계값 이상인 영역의 데이터만 필터링.
- **시각화:**
    - **Figure 5:** 일반화 성능 검증 차트.
        - (상단) 임계값 이상 영역에서의 GT 맵과 매칭된 DA 맵 비교.
        - (하단) 해당 영역에서의 히스토그램 및 Q-Q 플롯을 통해 분포 유사성을 통계적으로 검증.

#### 4. 거리별 오차 분석 기능 추가
- **목표:** 어떤 거리 구간에서 오차가 크게 발생하는지 정량적으로 분석.
- **방법:**
    - 전체 유효 픽셀을 GT 기준 2m 간격의 거리 구간으로 그룹화.
    - 각 구간별 **평균 절대 오차(MAE, Mean Absolute Error)**와 **평균 상대 오차(MRE, Mean Relative Error)**를 계산.
- **시각화:**
    - **Figure 6:** 거리별 오차 분석 막대 그래프.
        - (좌) 거리 구간에 따른 MAE(m) 변화.
        - (우) 거리 구간에 따른 MRE(%) 변화.

#### 5. 스크립트 유연성 및 편의성 개선
- **동적 임계값 설정:** 스크립트 실행 시, 분포 학습에 사용할 거리 임계값을 사용자가 직접 입력하도록 수정 (기본값 8.0m).
- **동적 시각화:** 모든 그래프의 제목, 레이블, 파일명이 설정된 임계값에 따라 동적으로 생성되도록 f-string을 적용.
- **체계적인 결과 관리:** 분석 결과(이미지 파일)가 `output/scale_compare_[파일명]_[임계값]m/` 와 같이 설정값에 따라 별도의 폴더에 저장되도록 수정.

### 결론
단순 선형 스케일링부터 고급 분포 매칭 기법까지 단계적으로 구현하고, 각 단계의 결과를 시각적으로 검증하는 체계적인 분석 파이프라인을 구축함. 특히, 학습 데이터와 검증 데이터를 분리하여 모델의 일반화 성능을 평가하고, 거리별 오차 분석을 통해 모델의 취약 구간을 파악할 수 있는 기능을 추가하여 분석의 신뢰도를 크게 높임.
